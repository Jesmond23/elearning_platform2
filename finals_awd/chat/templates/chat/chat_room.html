{% load static %}

<h3 class="text-xl font-semibold text-gray-700 mb-4">Course Chat</h3>
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <!--Chat Log-->
    <div class="h-72 overflow-y-auto bg-gray-50 border border-gray-200 p-4 rounded space-y-3" id="chat-log">
        <!--Chat is appended here-->
    </div>
<!--Message form-->


        <form id="chat-form" class="mt-4 flex gap-2">
            {% csrf_token %}
            
                <input id ="chat-message-input" type="text" class="flex-1 border border-gray-300 px-4 py-2 rounded-md shadow-sm
                focus:outline-none focus:ring-blue-300 focus:ring" placeholder="Type your message here" autofocus/>
                <button id="chat-message-submit" type='submit' class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition">
                    Send</button>
   
        </form>

</div>


<!--Websocket Script-->
<script>
    const courseId = "{{ course.id }}";
    const userName = '{{ request.user.username }}';

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + courseId + '/'
    );

    chatSocket.onopen = function () {
        console.log("WebSocket connected to course " + courseId);
    };

    let lastSender = null;

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');
        const messageEl = document.createElement('div');

        const isOwnMessage = data.username === userName;
       

        const profilePic = data.profile_pic ?? '{% static "default-avatar.png" %}';

        const isNewSender = data.username !== lastSender;
        lastSender = data.username;

   messageEl.innerHTML = `
  <div class="flex ${isOwnMessage ? 'flex-row-reverse' : ''} items-start gap-2">
    ${isNewSender ? `<img src="${profilePic}" class="w-8 h-8 rounded-full">` : `<div class="w-8"></div>`}

    <div class="max-w-xs px-3 py-2 rounded-lg ${isOwnMessage ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}">
      ${isNewSender ? `<div class="font-semibold">${data.username} <span class="text-xs text-gray-300 ml-1">[${data.timestamp}]</span></div>` : `<div class="text-xs text-gray-400 mb-1">[${data.timestamp}]</div>`}
      <div>${data.message}</div>
    </div>
  </div>
`;
        // messageEl.innerHTML = `<small class="text-muted">[${data.timestamp}]</small> <strong>${data.username}:</strong> ${data.message}`;
        chatLog.appendChild(messageEl);
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-form').onsubmit = function (e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value.trim();
       if (message) {
      chatSocket.send(JSON.stringify({ message }));
      messageInputDom.value = '';
    }
    };
</script>


<style>
#chat-log .bg-light {
  background-color: #f1f1f1 !important;
}
</style>